<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - THPT Trần Thánh Tông</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .admin-container { max-width: 1000px; margin: 0 auto; padding: 20px; }
        .admin-header { background: var(--gradient-primary); color: white; padding: 20px; border-radius: 12px; margin-bottom: 30px; text-align: center; }
        .admin-section { background: white; padding: 25px; border-radius: 12px; box-shadow: var(--shadow); margin-bottom: 25px; }
        .admin-tabs { display: flex; gap: 10px; margin-bottom: 30px; flex-wrap: wrap; }
        .tab-btn { background: var(--light-gray); border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s; }
        .tab-btn.active, .tab-btn:hover { background: var(--secondary-color); color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .login-form { max-width: 400px; margin: 50px auto; background: white; padding: 40px; border-radius: 12px; box-shadow: var(--shadow-hover); }
        .form-row { display: flex; gap: 15px; margin-bottom: 15px; }
        .form-row > * { flex: 1; }
        .message-item { background: var(--light-gray); padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid var(--secondary-color); }
        .message-item.unread { border-left-color: var(--accent-color); background: #fff5f5; }
        .message-meta { font-size: 0.9em; color: var(--gray); margin-bottom: 8px; }
        .message-actions { margin-top: 10px; }
        .btn { background: var(--secondary-color); color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; margin-right: 10px; font-size: 0.9em; }
        .btn:hover { opacity: 0.9; }
        .btn-success { background: var(--success-color); }
        .btn-danger { background: var(--danger-color); }
        .class-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .class-item { background: var(--light-gray); padding: 15px; border-radius: 8px; text-align: center; }
        .hidden { display: none; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--gradient-primary); color: white; padding: 20px; border-radius: 12px; text-align: center; }
        .stat-number { font-size: 2em; font-weight: bold; margin-bottom: 5px; }
    </style>
</head>
<body>
    <!-- Login Form -->
    <div id="login-section" class="login-form">
        <div class="admin-header">
            <h2><i class="fas fa-shield-alt"></i> Đăng nhập Admin</h2>
        </div>
        <form onsubmit="adminLogin(event)">
            <div class="form-group">
                <label>Tài khoản:</label>
                <input type="text" id="admin-username" required placeholder="Nhập tài khoản">
            </div>
            <div class="form-group">
                <label>Mật khẩu:</label>
                <input type="password" id="admin-password" required placeholder="Nhập mật khẩu">
            </div>
            <button type="submit" class="send-btn" style="width: 100%;">
                <i class="fas fa-sign-in-alt"></i> Đăng nhập
            </button>
        </form>
        <p style="text-align: center; margin-top: 20px; color: var(--gray); font-size: 0.9em;">
            Tài khoản mặc định: admin / 123456
        </p>
    </div>

    <!-- Admin Dashboard -->
    <div id="admin-dashboard" class="admin-container hidden">
        <div class="admin-header">
            <h1><i class="fas fa-tachometer-alt"></i> Trang Quản Trị</h1>
            <p>Quản lý hệ thống THPT Trần Thánh Tông</p>
            <button onclick="adminLogout()" style="position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer;">
                <i class="fas fa-sign-out-alt"></i> Đăng xuất
            </button>
        </div>

        <!-- Stats Overview -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="total-messages">0</div>
                <div>Tin nhắn mới</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="total-students">0</div>
                <div>Học sinh</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="total-classes">0</div>
                <div>Lớp học</div>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="admin-tabs">
            <button class="tab-btn active" onclick="showTab('messages')">
                <i class="fas fa-envelope"></i> Tin nhắn
            </button>
            <button class="tab-btn" onclick="showTab('classes')">
                <i class="fas fa-school"></i> Quản lý lớp
            </button>
            <button class="tab-btn" onclick="showTab('settings')">
                <i class="fas fa-cog"></i> Cài đặt
            </button>
        </div>

        <!-- Messages Tab -->
        <div id="messages-tab" class="tab-content active">
            <div class="admin-section">
                <h3><i class="fas fa-dove"></i> Quản lý tin nhắn từ Bồ câu đưa thư</h3>
                <div id="messages-list">
                    <p style="text-align: center; color: var(--gray); padding: 20px;">
                        Chưa có tin nhắn nào...
                    </p>
                </div>
            </div>
        </div>

        <!-- Classes Tab -->
        <div id="classes-tab" class="tab-content">
            <div class="admin-section">
                <h3><i class="fas fa-plus-circle"></i> Thêm lớp mới</h3>
                <form onsubmit="addClass(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Khối lớp:</label>
                            <select id="grade-select" required>
                                <option value="">Chọn khối</option>
                                <option value="10">Khối 10</option>
                                <option value="11">Khối 11</option>
                                <option value="12">Khối 12</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Tên lớp:</label>
                            <input type="text" id="class-name" required placeholder="VD: 10A6">
                        </div>
                        <div class="form-group">
                            <label>Niên khóa:</label>
                            <input type="number" id="class-year" required value="2024" min="2020" max="2030">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-plus"></i> Thêm lớp
                    </button>
                </form>
            </div>

            <div class="admin-section">
                <h3><i class="fas fa-list"></i> Danh sách lớp hiện tại</h3>
                <div id="classes-overview">
                    <div class="class-grid" id="current-classes">
                        <!-- Sẽ được tạo bởi JavaScript -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settings-tab" class="tab-content">
            <div class="admin-section">
                <h3><i class="fas fa-database"></i> Quản lý dữ liệu</h3>
                <p>Các chức năng quản lý hệ thống:</p>
                <div style="margin-top: 20px;">
                    <button class="btn" onclick="exportData()">
                        <i class="fas fa-download"></i> Xuất dữ liệu
                    </button>
                    <button class="btn btn-danger" onclick="resetData()" style="margin-left: 10px;">
                        <i class="fas fa-trash"></i> Xóa toàn bộ dữ liệu
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Reply Modal -->
    <div class="modal" id="reply-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-reply"></i> Trả lời tin nhắn</h3>
                <button class="close-btn" onclick="closeReplyModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="original-message" style="background: var(--light-gray); padding: 15px; border-radius: 8px; margin-bottom: 20px;"></div>
                <form onsubmit="sendReply(event)">
                    <div class="form-group">
                        <label>Phản hồi:</label>
                        <textarea id="reply-content" required placeholder="Nhập nội dung phản hồi..." rows="5"></textarea>
                    </div>
                    <button type="submit" class="send-btn">
                        <i class="fas fa-paper-plane"></i> Gửi phản hồi
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        // Admin credentials
        const ADMIN_CREDENTIALS = { username: 'admin', password: '123456' };
        let currentReplyMessageId = null;

        // Login function
        function adminLogin(event) {
            event.preventDefault();
            const username = document.getElementById('admin-username').value;
            const password = document.getElementById('admin-password').value;
            
            if (username === ADMIN_CREDENTIALS.username && password === ADMIN_CREDENTIALS.password) {
                document.getElementById('login-section').classList.add('hidden');
                document.getElementById('admin-dashboard').classList.remove('hidden');
                loadAdminData();
            } else {
                alert('Tài khoản hoặc mật khẩu không đúng!');
            }
        }

        // Logout function
        function adminLogout() {
            document.getElementById('admin-dashboard').classList.add('hidden');
            document.getElementById('login-section').classList.remove('hidden');
            document.getElementById('admin-username').value = '';
            document.getElementById('admin-password').value = '';
        }

        // Tab switching
        function showTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + '-tab').classList.add('active');
            
            if (tabName === 'messages') loadMessages();
            if (tabName === 'classes') loadClasses();
        }

        // Load admin data
        function loadAdminData() {
            loadData(); // Load from script.js
            updateStats();
            loadMessages();
            loadClasses();
        }

        // Update statistics
        function updateStats() {
            const unreadMessages = schoolData.messages.filter(m => m.status === 'unread').length;
            document.getElementById('total-messages').textContent = unreadMessages;
            document.getElementById('total-students').textContent = schoolData.students.length;
            
            let totalClasses = 0;
            Object.values(schoolData.grades).forEach(grade => totalClasses += grade.length);
            document.getElementById('total-classes').textContent = totalClasses;
        }

        // Load messages
        function loadMessages() {
            const messagesList = document.getElementById('messages-list');
            
            if (schoolData.messages.length === 0) {
                messagesList.innerHTML = '<p style="text-align: center; color: var(--gray); padding: 20px;">Chưa có tin nhắn nào...</p>';
                return;
            }
            
            messagesList.innerHTML = schoolData.messages.map(msg => `
                <div class="message-item ${msg.status === 'unread' ? 'unread' : ''}">
                    <div class="message-meta">
                        <strong>${msg.senderName}</strong> ${msg.senderClass ? `- Lớp: ${msg.senderClass}` : ''} 
                        <span style="float: right;">${new Date(msg.timestamp).toLocaleString('vi-VN')}</span>
                    </div>
                    <div style="margin: 10px 0;">${msg.content}</div>
                    <div class="message-actions">
                        <button class="btn" onclick="replyMessage('${msg.id}')">
                            <i class="fas fa-reply"></i> Trả lời
                        </button>
                        <button class="btn btn-success" onclick="markAsRead('${msg.id}')" ${msg.status === 'read' ? 'disabled' : ''}>
                            <i class="fas fa-check"></i> Đánh dấu đã đọc
                        </button>
                        <button class="btn btn-danger" onclick="deleteMessage('${msg.id}')">
                            <i class="fas fa-trash"></i> Xóa
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Load classes
        function loadClasses() {
            const container = document.getElementById('current-classes');
            let html = '';
            
            Object.entries(schoolData.grades).forEach(([grade, classes]) => {
                classes.forEach(cls => {
                    html += `
                        <div class="class-item">
                            <h4>${cls.name}</h4>
                            <p>Niên khóa: ${cls.year}</p>
                            <p>Học sinh: ${cls.studentCount}</p>
                            <button class="btn btn-danger" onclick="deleteClass('${grade}', '${cls.id}')" style="margin-top: 10px; font-size: 0.8em;">
                                <i class="fas fa-trash"></i> Xóa
                            </button>
                        </div>
                    `;
                });
            });
            
            container.innerHTML = html;
        }

        // Add new class
        function addClass(event) {
            event.preventDefault();
            const grade = document.getElementById('grade-select').value;
            const className = document.getElementById('class-name').value;
            const year = parseInt(document.getElementById('class-year').value);
            
            const newClass = {
                id: className.toLowerCase().replace(/\s+/g, ''),
                name: className,
                year: year,
                studentCount: 0,
                image: null
            };
            
            schoolData.grades[grade].push(newClass);
            saveData();
            
            // Reset form
            event.target.reset();
            
            // Reload display
            loadClasses();
            updateStats();
            
            alert(`Đã thêm lớp ${className} vào khối ${grade}`);
        }

        // Delete class
        function deleteClass(grade, classId) {
            if (confirm('Bạn có chắc muốn xóa lớp này?')) {
                schoolData.grades[grade] = schoolData.grades[grade].filter(cls => cls.id !== classId);
                saveData();
                loadClasses();
                updateStats();
            }
        }

        // Message functions
        function markAsRead(messageId) {
            const message = schoolData.messages.find(m => m.id === messageId);
            if (message) {
                message.status = 'read';
                saveData();
                loadMessages();
                updateStats();
            }
        }

        function deleteMessage(messageId) {
            if (confirm('Bạn có chắc muốn xóa tin nhắn này?')) {
                schoolData.messages = schoolData.messages.filter(m => m.id !== messageId);
                saveData();
                loadMessages();
                updateStats();
            }
        }

        function replyMessage(messageId) {
            const message = schoolData.messages.find(m => m.id === messageId);
            if (message) {
                currentReplyMessageId = messageId;
                document.getElementById('original-message').innerHTML = `
                    <strong>Từ: ${message.senderName}</strong> ${message.senderClass ? `(${message.senderClass})` : ''}<br>
                    <strong>Nội dung:</strong> ${message.content}
                `;
                document.getElementById('reply-modal').classList.add('show');
            }
        }

        function closeReplyModal() {
            document.getElementById('reply-modal').classList.remove('show');
            document.getElementById('reply-content').value = '';
            currentReplyMessageId = null;
        }

        function sendReply(event) {
            event.preventDefault();
            const replyContent = document.getElementById('reply-content').value;
            
            // Giả lập gửi phản hồi (có thể tích hợp email sau này)
            alert(`Phản hồi đã được gửi:\n"${replyContent}"\n\n(Tính năng gửi email sẽ được phát triển sau)`);
            
            // Đánh dấu tin nhắn đã trả lời
            const message = schoolData.messages.find(m => m.id === currentReplyMessageId);
            if (message) {
                message.status = 'replied';
                message.adminReply = replyContent;
                message.replyTime = new Date().toISOString();
                saveData();
            }
            
            closeReplyModal();
            loadMessages();
        }

        // Data management
        function exportData() {
            const data = JSON.stringify(schoolData, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'school-data-backup.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        function resetData() {
            if (confirm('CẢNH BÁO: Thao tác này sẽ xóa toàn bộ dữ liệu! Bạn có chắc chắn?')) {
                if (confirm('Lần xác nhận cuối cùng. Dữ liệu sẽ không thể khôi phục!')) {
                    // Reset to default data structure
                    schoolData.messages = [];
                    schoolData.students = [];
                    Object.keys(schoolData.grades).forEach(grade => {
                        schoolData.grades[grade].forEach(cls => {
                            cls.studentCount = 0;
                            cls.image = null;
                        });
                    });
                    saveData();
                    loadAdminData();
                    alert('Dữ liệu đã được reset thành công!');
                }
            }
        }

        // Initialize admin page
        document.addEventListener('DOMContentLoaded', function() {
            // Auto-load data if coming from main site
            if (window.schoolData) {
                // Already loaded from script.js
            }
        });
    </script>
</body>
</html>
